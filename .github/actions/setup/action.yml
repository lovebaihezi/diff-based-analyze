name: Set Up

description: Install Zig, Alpine, libgit2, zlib, libclang

runs:
  using: composite
  steps:
    - name: Setup Alpine
      shell: sh
      run: |
        apk update
        apk add ninja-build nodejs cmake wget tar samurai xz just make gzip bash git shadow curl fish

    - name: Setup Nix
      shell: bash
      run: |
        echo 'NIX_PATH="nixpkgs=channel:nixos-unstable"' >> $GITHUB_ENV
        scripts/install-nix.sh
      env:
        INPUT_EXTRA_NIX_CONFIG: ""
        INPUT_INSTALL_OPTIONS: ""
        INPUT_INSTALL_URL: ""
        INPUT_NIX_PATH: ""
        GITHUB_TOKEN: ${{ github.token }}

    - name: Setup Opam
      shell: bash
      run: |
        apk add opam m4 make gcc g++ musl-dev linux-headers

    - name: Initialize OPAM
      shell: bash
      run: opam init --disable-sandboxing --kind=local

    - name: Update OPAM Repository
      shell: bash
      run: opam update

    - name: Install OCaml Compiler
      shell: bash
      run: |
        opam switch create 4.14.1+musl+static+flambda
        eval $(opam env)

    - name: Check Nix
      shell: fish 
      run: |
        if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
          . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
        fi
        source ~/.bashrc
        nix --versoin

    - name: Configure Nix
      shell: bash
      run: |
        mkdir -p ~/.config/nix
        echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

    - uses: goto-bus-stop/setup-zig@v2.2.0

    - name: Check Zig ENV
      shell: bash
      run: zig env

    - name: Install libclang and static binaries
      shell: bash
      run: |
        apk add clang17-dev clang17-static musl-dev libc++-dev libc++-static openssl-dev clang17-analyzer
        echo "CC=clang-17" >> $GITHUB_ENV
        echo "CXX=clang++-17" >> $GITHUB_ENV

    - name: Build libgit2, zlib
      shell: bash
      run: |
        just install-libgit2 && just build-libgit2
        just install-zlib && just build-zlib

    - name: Run zig fmt
      shell: bash
      run: zig fmt --check .


